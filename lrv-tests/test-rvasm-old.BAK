
(defpackage "TEST-RVASM"
  (:use :cl :rvasm)
  (:export #:*test-name* #:report-result #:report-combined-result #:combine-results
           #:set-env #:cdvec
           #:check-vait #:check-jait

   ))

(in-package :test-rvasm)

(defvar *test-name* test)

(defun report-result (result form binary)
  "Report the results of a single test case. Called by 'check'"
  (format t "~:[FAIL~;pass~] ... ~a: ~a~,10t~32,'0b~%" result *test-name* form binary)
  result)

(defun report-combined-result (result )
       (format t "~:[FAIL~;pass~] ... ~a~%" result *test-name*)
  )

(defmacro with-gensyms ((&rest names) &body body)
  `(let ,(loop for n in names collect `(,n (gensym)))
     ,@body))

(defmacro combine-results (&body forms)
  (with-gensyms (result)
    `(let ((,result t))
       ,@(loop for f in forms collect `(unless ,f (setf ,result nil)))
       `,(format t "~:[FAIL~;pass~] ... ~a~%" result *test-name*)
       ;; `(report-combined-result ,result)
       ,result)))

(defun set-env ()
  (progn
    (defparameter *global-env* (make-instance 'basic-env :address 0))
    (setf *env* *global-env*)
    (setf *max-address* 4000)
    ))

(defun cdvec ()
  (env-code-vector *env*))

(defun do-read-byte (num)
  (coerce (loop for i upto num collect
                               (aref (env-code-vector *env*) num))
          'vector))

(defun read-first-byte ()
    (aref (env-code-vector *env*) 0))

(defun read-first-jyte ()
    (vector
     (aref (env-code-vector *env*) 0 )
     (aref (env-code-vector *env*) 1 )))

(defun read-first-vyte ()
    (vector
     (aref (env-code-vector *env*) 0 )
     (aref (env-code-vector *env*) 1 )
     (aref (env-code-vector *env*) 2 )
     (aref (env-code-vector *env*) 3 )))

(defun read-first-zyte ()
  (aref (env-code-vector *env*) 0 )
  (aref (env-code-vector *env*) 1 )
  (aref (env-code-vector *env*) 2 )
  (aref (env-code-vector *env*) 3 )
  (aref (env-code-vector *env*) 4 )
  (aref (env-code-vector *env*) 5 )
  (aref (env-code-vector *env*) 6 )
  (aref (env-code-vector *env*) 7 )
  (aref (env-code-vector *env*) 8 ))


(defun check-vait (code)
  (equalp (read-first-vyte) (encode-vait code) ))

(defun check-jait (code)
  (equalp (read-first-jyte) (encode-jait code) ))

(defmacro do-vait-test (func test-list)
  (let ((*test-name* func))
  ;; `(format t "~:[FAIL~;pass~] ... ~a~%"
     ;; `(report-combined-result
            `(combine-results
               ;; `(progn
               ,@(loop for f in test-list collect
                       `(progn ,(set-env)
                               ,(apply func (butlast f 1))
                               ,(report-result (apply #'check-vait (last f))
                                               (butlast f 1) (car (last f)))))
              );  ); ,*test-name*)
    ))





(defun linke ()
  (link *env*))




;; (def-vait-test test-or (#'i.or)
;;    ;; '(
;;     '(x0  x0  x0    #b00000000000000000110000000010011)
;;     '(x31 x0  x0    #b00000000000000000110111110010011)
;;     '(x0  x31 x0    #b00000000000011111110000000110011)
;;     '(x31 x31 x0    #b00000000000011111110111110110011)
;;     '(x0  x0  x31   #b00000001111100000110000000110011)
;;     '(x31 x0  x31   #b00000001111100000110111110110011)
;;     '(x0  x31 x31   #b00000001111111111110000000110011)
;;     '(x31 x31 x31   #b00000001111111111110111110110011)

;;     ;; )
;;   )

;; (defmacro def-vait-test (name fun-list test-list)
;;   (let ((func (car funlist))
;;         (forms test-list))
;;     `(defun ,name func forms)
;;        ,@(loop for f in forms collect
;;       `(progn ,(set-env)
;;              ,(apply func (butlast f 1))
;;                     ,(report-result (apply check-vait (last f))
;;                                    (butlast f 1) (last f)))
;;       )
;;      )
;;     )
;; (defmacro def-vait-test (name fun-list &rest test-list)
;;   ;; (let ((func (car funlist))
;;         ;; (forms test-list))
;;     `(defun ,name ()
;;        ,@(loop for f in test-list collect
;;       `(progn ,(set-env)
;;              ,(apply (car fun-list) (butlast f 1))
;;                     ,(report-result (apply #'check-vait (last f))
;;                                    (butlast f 1) (last f)))
;;       )
;;      )
;;   )
