
(load "../lrv-korr/packages.lisp")
(load "../lrv-korr/env-lrv.cl")
(load "../lrv-korr/fmt-lrv.cl")
(load "../lrv-korr/kone-lrv.cl")

(load "./test-rvasm.cl")

;; (load "~/.eclrc")
(load "../lrv-ins/C-lrv.cl")

(defpackage "TEST-C-32"
  (:documentation "Test functions for the risc-v 32 bit compressed instructions")
  (:use :cl :rvasm :c-32-rv :test-rvasm)
  )

(in-package :test-c-32)

(combine-results

(do-jait-test c.nop
  ((#b0000000000000001)))


(do-jait-test c.addi ;; rd non-zero sign extended imm6
  ((x1  1      #b0000000010000101)
   (x31 1      #b0000111110000101)
   (x1  -1     #b0001000011111101)
   (x31 -1     #b0001111111111101)
   (x1  #x1F   #b0000000011111101)
   (x31 #x1F   #b0000111111111101)
   (x1  #x-20  #b0001000010000001)
   (x1  20     #b0000000011010001)))


(do-jait-test c.li ;; rd sign extended imm6
  ((x1  0     #b0100000010000001)
   (x31 0     #b0100111110000001)
   (x1  #x1f  #b0100000011111101) ;;011111
   (x31 #x1f  #b0100111111111101)
   (x1  1     #b0100000010000101)
   (x1  10    #b0100000010101001)
   (x1  -1    #b0101000011111101) ;;111111
   (x1  #x-20 #b0101000010000001)))


(do-jait-test c.addi4spn ;; non-zero zero extended imm10 multiple of 4
  ((x8  4    #b0000000001000000)
   (x15 4    #b0000000001011100)
   (x8  1020 #b0001111111100000)
   (x15 1020 #b0001111111111100)
   (x8  #x20 #b0001000000000000)
   (x8  #xfc #b0001100111100000)
   (x8  #xc  #b0000000001100000)
   (x8  20   #b0000100001000000)))


(do-jait-test c.addi16sp ;; non-zero sign extended imm10 multiple of 16 (#x10/#b10000)
  ((#x10   #b0110000101000001)
   (#x-10  #b0111000101111101)
   (#x1f0  #b0110000101111101)
   (#x-200 #b0111000100000001)
   (#xf0   #b0110000101101101)
   (#x-f0  #b0111000101010001)
   (#x20   #b0110000100000101)
   (#x-20  #b0111000100111101)))


(do-jait-test c.lui ;; rd non-zero sign extended imm17 multiple of 4096 (#x1000)
  ((x1  #x1000   #b0110000010000101)
   (x31 #x1000   #b0110111110000101)
   (x1  #x-1000  #b0111000011111101)
   (x31 #x-1000  #b0111111111111101)
   (x1  #xf000   #b0110000010111101)
   (x1  #x2000   #b0110000010001001)
   (x1  #x-f000  #b0111000011000101) ;;??
   (x1  #x-10000 #b0111000011000001)))


(do-jait-test c.andi ;; rd sign extended imm6
  ((x8  0     #b1000100000000001)
   (x15 0     #b1000101110000001)
   (x8  -1    #b1001100001111101)
   (x15 -1    #b1001101111111101)
   (x8  #x-20 #b1001100000000001)
   (x15 #x-20 #b1001101110000001)
   (x8  #x1f  #b1000100001111101)
   (x15 #x1f  #b1000101111111101)))


(do-jait-test c.srli
  ((x8  1  #b1000000000000101)
   (x15 1  #b1000001110000101)
   (x8  31 #b1000000001111101)
   (x15 31 #b1000001111111101)
   (x8  7  #b1000000000011101)
   (x8  15 #b1000000000111101)
   (x8  25 #b1000000001100101)
   (x8  8  #b1000000000100001)))


(do-jait-test c.srai
  ((x8  1  #b1000010000000101)
   (x15 1  #b1000011110000101)
   (x8  31 #b1000010001111101)
   (x15 31 #b1000011111111101)
   (x8  7  #b1000010000011101)
   (x8  15 #b1000010000111101)
   (x8  25 #b1000010001100101)
   (x8  8  #b1000010000100001)))


(do-jait-test c.slli
  ((x1  1  #b0000000010000110)
   (x31 1  #b0000111110000110)
   (x1  31 #b0000000011111110)
   (x31 31 #b0000111111111110)
   (x1  7  #b0000000010011110)
   (x1  5  #b0000000010010110)
   (x1  25 #b0000000011100110)
   (x1  8  #b0000000010100010)))


(do-jait-test c.mv
  ((x1  x31 #b1000000011111110)
   (x31 x1  #b1000111110000110)
   (x1  x31 #b1000000011111110)
   (x31 x1  #b1000111110000110)
   (x1  x1  #b1000000010000110)
   (x3  x1  #b1000000110000110)
   (x1  x2  #b1000000010001010)
   (x4  x8  #b1000001000100010)))


(do-jait-test c.add
  ((x1  x31 #b1001000011111110)
   (x31 x1  #b1001111110000110)
   (x1  x31 #b1001000011111110)
   (x31 x1  #b1001111110000110)
   (x1  x1  #b1001000010000110)
   (x3  x1  #b1001000110000110)
   (x1  x2  #b1001000010001010)
   (x4  x8  #b1001001000100010)))


(do-jait-test c.sub
  ((x8  x15 #b1000110000011101)
   (x15 x8  #b1000111110000001)
   (x8  x8  #b1000110000000001)
   (x15 x15 #b1000111110011101)
   (x10 x11 #b1000110100001101)
   (x11 x10 #b1000110110001001)
   (x14 x11 #b1000111100001101)
   (x11 x14 #b1000110110011001)))


(do-jait-test c.xor
  ((x8  x15 #b1000110000111101)
   (x15 x8  #b1000111110100001)
   (x8  x8  #b1000110000100001)
   (x15 x15 #b1000111110111101)
   (x10 x11 #b1000110100101101)
   (x11 x10 #b1000110110101001)
   (x14 x11 #b1000111100101101)
   (x11 x14 #b1000110110111001)))


(do-jait-test c.or
  ((x8  x15 #b1000110001011101)
   (x15 x8  #b1000111111000001)
   (x8  x8  #b1000110001000001)
   (x15 x15 #b1000111111011101)
   (x10 x11 #b1000110101001101)
   (x11 x10 #b1000110111001001)
   (x14 x11 #b1000111101001101)
   (x11 x14 #b1000110111011001)))


(do-jait-test c.and
  ((x8  x15 #b1000110001111101)
   (x15 x8  #b1000111111100001)
   (x8  x15 #b1000110001111101)
   (x8  x8  #b1000110001100001)
   (x15 x15 #b1000111111111101)
   (x10 x11 #b1000110101101101)
   (x11 x10 #b1000110111101001)
   (x14 x11 #b1000111101101101)))


(do-jait-test c.j ;; sign extended imm12 multiple of 2
  ((0      #b1010000000000001)
   (#x7fe  #b1010111111111101)   ;;011111111110
   (#x-800 #b1011000000000001)   ;;100000000000
   (#xfe   #b1010100011111101)   ;;000011111110
   (#x7e   #b1010100010111101)   ;;000001111110
   (2      #b1010000000001001)   ;;000000000010
   (-2     #b1011111111111101)   ;;111111111110
   (20     #b1010100000010001))) ;;000000010100


(do-jait-test c.jal ;; sign extended imm12 multiple of 2
  (( 0      #b0010000000000001)
   ( #x7fe  #b0010111111111101)
   ( #x-800 #b0011000000000001)
   ( #xfe   #b0010100011111101)
   ( #x7e   #b0010100010111101)
   ( 2      #b0010000000001001)
   ( -2     #b0011111111111101)
   ( 20     #b0010100000010001)))


(do-jait-test c.jr ;; check orientation
  ((x1  #b1000000010000010)
   (x31 #b1000111110000010)
   (x2  #b1000000100000010)
   (x30 #b1000111100000010)
   (x4  #b1000001000000010)
   (x5  #b1000001010000010)
   (x7  #b1000001110000010)
   (x8  #b1000010000000010)))


(do-jait-test c.jalr  ;; check orientation
  ((x1  #b1001000010000010)
   (x31 #b1001111110000010)
   (x2  #b1001000100000010)
   (x30 #b1001111100000010)
   (x4  #b1001001000000010)
   (x5  #b1001001010000010)
   (x7  #b1001001110000010)
   (x8  #b1001010000000010)))


(do-jait-test c.beqz ;; rd  sign extended imm9 multiple of 2
  ((x8  0      #b1100000000000001)
   (x15 0      #b1100001110000001)
   (x8  2      #b1100000000001001)
   (x15 2      #b1100001110001001)
   (x8  -2     #b1101110001111101)   ;;111111110
   (x15 -2     #b1101111111111101)
   (x8  #xfe   #b1100110001111101)   ;;011111110
   (x8  #x-100 #b1101000000000001))) ;;100000000


(do-jait-test c.bnez ;; rd  sign extended imm9 multiple of 2
  ((x8  0      #b1110000000000001)
   (x15 0      #b1110001110000001)
   (x8  2      #b1110000000001001)
   (x15 2      #b1110001110001001)
   (x8  -2     #b1111110001111101)
   (x15 -2     #b1111111111111101)
   (x8  #xfe   #b1110110001111101)
   (x8  #x-100 #b1111000000000001)))


(do-jait-test c.lv ;; rd rb (zero extended imm7 mutible of 4)
  ((x8  x15 0    #b0100001110000000)
   (x15 x8  0    #b0100000000011100)
   (x8  x15 #x7c #b0101111111100000)
   (x15 x8  #x7c #b0101110001111100)
   (x8  x8  #x3c #b0101110001000000)
   (x8  x8  #x1c #b0100110001000000)
   (x8  x8  #xc  #b0100010001000000)
   (x8  x8  #x58 #b0100110000100000)))


(do-jait-test c.sv ;; rs rb (zero extended imm7 mutible of 4)
  ((x8  x15 0    #b1100001110000000)
   (x15 x8  0    #b1100000000011100)
   (x8  x15 #x7c #b1101111111100000) ;;1111100
   (x15 x8  #x7c #b1101110001111100)
   (x8  x8  #x3c #b1101110001000000) ;;0111100
   (x8  x8  #x1c #b1100110001000000) ;;0011100
   (x8  x8  #xc  #b1100010001000000) ;;0001100
   (x8  x8  #x58 #b1100110000100000))) ;; 1011000


(do-jait-test c.lvsp ;; rd (zero extended imm8 multiple of 4
  ((x1  0    #b0100000010000010)
   (x31 0    #b0100111110000010)
   (x1  #xfc #b0101000011111110)
   (x31 #xfc #b0101111111111110)
   (x1  #x7c #b0101000011110110)
   (x1  #x1c #b0100000011110010)
   (x1  #xc  #b0100000010110010)
   (x1  #x58 #b0100000011100110)))


(do-jait-test c.svsp ;; rb (zero extended imm8 multiple of 4)
  ((x0  0    #b1100000000000010)
   (x31 0    #b1100000001111110)
   (x0  #xfc #b1101111110000010) ;; 11111100
   (x31 #xfc #b1101111111111110)
   (x0  #x7c #b1101111010000010) ;; 01111100
   (x0  #x1c #b1100111000000010) ;; 00011100
   (x0  #xc  #b1100011000000010) ;; 00001100
   (x0  #x58 #b1100110010000010))) ;; 01011000


(do-jait-test c.ebreak
  ((#b1001000000000010)))


  )
